<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>1h Gainers & Losers</title>
<style>
    body {
        width: 480px;
        height: 480px;
        margin: 0;
        background: black;
        color: white;
        font-family: Arial, sans-serif;
        padding: 20px;
        box-sizing: border-box;
    }
    h2 {
        font-size: 26px;
        margin: 10px 0;
        text-align: left;
    }
    .item {
        display: flex;
        justify-content: space-between;
        font-size: 22px;
        margin: 5px 0;
    }
    .green { color: #00ff7f; }
    .red { color: #ff5252; }
</style>
</head>
<body>

<h2>1h Gainers</h2>
<div id="gainers"></div>

<h2>1h Losers</h2>
<div id="losers"></div>

<script>
const VS_CURRENCY = "usd";
const MAX_PAGES = 4;       // 4 * 250 = top 1000 coins by mcap
const MIN_VOL_USD = 50000; // match CG: only coins with >= $50k 24h volume

async function fetchAllPages() {
    const allData = [];
    for (let page = 1; page <= MAX_PAGES; page++) {
        const url =
          `https://api.coingecko.com/api/v3/coins/markets` +
          `?vs_currency=${VS_CURRENCY}` +
          `&order=market_cap_desc` +
          `&per_page=250&page=${page}` +
          `&sparkline=false` +
          `&price_change_percentage=1h`;

        const res = await fetch(url);
        if (!res.ok) break;

        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) break;

        allData.push(...data);
    }
    return allData;
}

async function loadData() {
    try {
        const data = await fetchAllPages();

        // Filter like CoinGecko's endpoint: valid 1h change + decent volume
        const filtered = data.filter(c =>
            c.price_change_percentage_1h_in_currency !== null &&
            c.price_change_percentage_1h_in_currency !== undefined &&
            c.total_volume !== null &&
            c.total_volume >= MIN_VOL_USD
        );

        // Top 5 gainers (highest 1h %)
        const gainers = [...filtered]
            .sort((a, b) =>
                b.price_change_percentage_1h_in_currency -
                a.price_change_percentage_1h_in_currency
            )
            .slice(0, 5);

        // Top 5 losers (lowest 1h %)
        const losers = [...filtered]
            .sort((a, b) =>
                a.price_change_percentage_1h_in_currency -
                b.price_change_percentage_1h_in_currency
            )
            .slice(0, 5);

        document.getElementById("gainers").innerHTML =
            gainers.map(c => `
                <div class="item">
                    <span>${c.symbol.toUpperCase()}</span>
                    <span class="green">
                        ${c.price_change_percentage_1h_in_currency >= 0 ? "+" : ""}
                        ${c.price_change_percentage_1h_in_currency.toFixed(2)}%
                    </span>
                </div>
            `).join("");

        document.getElementById("losers").innerHTML =
            losers.map(c => `
                <div class="item">
                    <span>${c.symbol.toUpperCase()}</span>
                    <span class="red">
                        ${c.price_change_percentage_1h_in_currency.toFixed(2)}%
                    </span>
                </div>
            `).join("");

    } catch (error) {
        console.error(error);
        document.body.innerHTML = "<h2>Error loading data</h2>";
    }
}

loadData();
// Be careful with rate limits â€“ 60s is usually safe
setInterval(loadData, 60000);
</script>

</body>
</html>
